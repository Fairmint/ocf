# Transaction Tracing

Perhaps the important part of interacting with OCF will be traversing the event stack to determine the current state of a company's cap table. Most of the time, that will involve tracking the state of a given issuance of securities to a stakeholder from the date of issuance until the issuance is ultimately extinguished - meaning no shares remaining outstanding under the original `security_id`.

## Refresher on OCF IDs

Remember, there are multiple IDs associated with issuance transactions, and each has a different purpose:

1. `id` - Remember, every OCF object has an id. This is meant to be a unique identifier within OCF such that no two objects _of the same type_ within a given OCF export have the same `id` value. (though the specific form is up to a given implementer). While implementers can assign id values that have significance elsewhere in their systems - e.g. using ids that correspond to some significant value in other cap tables or some sort of global registry of securities - we only use OCF `id` values to identify objects for programmatic processing and extraction of OCF cap table data.
2. `security_id` - This is best thought of as analgous to a certificate id in the old fashioned paper security world. Every issuance has a `security_id`, and this ID should be used anytime another transaction is acting on the shares issued in the issuance event identified with this `security_id`. **Here are a couple illustrations of where and how `security_id` is used**:
   1. To exercise an option, the `PlanSecurityExercise` transaction refers to a `security_id`. This must be the the `security_id` of the `PlanSecurityIssuance` event used to issue the option being exercised.
   2. To transfer shares of stock, the `StockTransfer` transaction's `security_id` field should contain the id of the `security_id` value provided in the `StockIssuance` event used to issue the original shares being transferred.
3. `custom_id` - is a freetext field provided to store a certificate ID (or some sort of other, implementer-specific id for a given issuance of securities).
4. `share_numbers_issued` - is meant to track specific share numbers that are part of an issuance in situations where shares are **not** fungible. For example, in a jurisdiction where issuing shares 300 - 500 is legall significant and different from issuing shares 700 - 900, you'd need to use this field to track the share numbers that are part of a given issuance.

## Terminal Transactions

A **terminal** transaction is one which none of the securities originally issued as part of an issuance event under a given `security_id` remain issued under the same `security_id`. Except for Issuances, which create a given issuance under a given `security_id`, all of our OCF transactions are terminal. Even where a given issuance remains outstanding in part - for example, where 1,000 shares are issued to Bob and then Bob transfers 500 to Frank, leaving 500 of the original 1,000 issued to Bob - the OCF spec requires that you create a new `security_id` for the "remainder" that remains outstanding in the name of the original holder. In many of our transaction events, you'll see an optional `balance_security_id` field. If the `balance_security_id` is present, it indicates a remainder from an earlier `security_id` (as illustrated in the preceding example with Bob and Frank) is still held by the original holder but now under a new `security_id`.

Issuance and Acceptance transactions are **not** terminal. Here's a list of OCF Transaction types which are terminal, along with a detailed explanation of where there can be resulting security ids:

1. **Cancellation Events** - transactions composed of [Cancellation](../schema_markdown/schema/primitives/objects/transactions/cancellation/Cancellation.md) - which includes `StockCancellation`, `WarrantCancellation`, `PlanSecurityCancellation` and `ConvertibleCancellation` - all extingush a given `security_id` and must refer to the pre-exsting `security_id` of the securities being cancelled. These transactions assume you can cancel an existing issuance in whole _or in-part_. Their `balance_security_id` field is meant to be used where an issuance is cancelled in-part and some of the original securities issued under the original `security_id` remain outstanding, issued to the same stakeholder as the original `security_id`.
2. **Conversion Events** - transactions composed of [Conversion](../schema_markdown/schema/primitives/objects/transactions/conversion/Conversion.md) - which includes `ConvertibleConversion` and `StockConversion` - are terminal. These events must link to the `security_id` of the original issuance being converted. If the `balance_security_id` field is present, it means the original security was only converted in-part and the remaining securities have the new `security_id` provided in the `balance_security_id` field. Any resulting securities from the conversion - e.g. Stock issued as part of a Convertible conversion or a conversion from preferred to common - should have their issuance ids in the `resulting_security_ids` field.
3. **Exercise Events** - transactions composed of [Exercise](../schema_markdown/schema/primitives/objects/transactions/exercise/Exercise.md) - which includes `PlanSecurityExercise` and `WarrantExercise` - are terminal. These events must link to the `security_id` of the original issuance being converted. If the `balance_security_id` field is present, it means the original security was only converted in-part and the remaining securities have the new `security_id` provided in the `balance_security_id` field. Any resulting securities from the conversion - e.g. Stock issued from a warrant or option exercise - should have their issuance ids in the `resulting_security_ids` field.
4. **Stock Repurchase** - [StockRepurchase](../schema_markdown/schema/objects/transactions/repurchase/StockRepurchase.md) transactions must link to the `security_id` of the original stock issuance that is being repurchased. Their `balance_security_id` field is meant to be used where an issuance is only repurchased in-part and some of the original securities issued under the original `security_id` remain outstanding, issued to the same stakeholder as the original `security_id`.
5. **Stock Reissuance** - TODO - complete.
6. **Plan Security Release** - TODO - complete
7. **Retraction Events** - transactions composed of [Retraction](../schema_markdown/schema/primitives/objects/transactions/retraction/Retraction.md) - which includes `StockRetraction`, `WarrantRetraction`, `PlanSecurityRetraction` and `ConvertibleRetraction` - must link to the `security_id` of the original security issuance that is being retracted. Unlike many of the preceding transaction types, there is never a `balance_security_id` on this transaction type.
8. **Transfer Events** - transactions composed of [Transfer](../schema_markdown/schema/primitives/objects/transactions/transfer/Transfer.md) - which includes `StockTransfer`, `WarrantTransfer`, `PlanSecurityTransfer` and `ConvertibleTransfer` - transactions must link to the `security_id` of the original issuance the transferred securities were issued as a part of. This transfer can be in whole or in part, and it can be to a single new issuance or to multiple new issuances. If the transfer is in-part, any remaining securities must be issued with a new `security_id` which should be referred to as the `balance_security_id`. The `security_id`s of the resulting issuances to the transferees should be recorded in an array in the `resulting_security_ids` field.
